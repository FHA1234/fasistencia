<script>
// --- Config caché (usa tu misma clave si ya tienes otra) ---
const LS_KEY = 'rosterCacheV3';

// --- Detecta comando admin SOLO si empieza por "@admin " ---
function getAdminPassword(texto){
  const m = /^@admin\s+(.+)$/i.exec((texto || '').trim());
  return m ? m[1] : null;
}

// --- Envío del formulario con lógica admin mínima ---
form.addEventListener('submit', async (e)=>{
  const pw = getAdminPassword(respuesta.value);

  // 1) MODO ADMIN: si la respuesta empieza por "@admin <clave>", NO fichamos; solo refrescamos lista
  if (pw) {
    e.preventDefault();
    try {
      const r = await apiPOST('/flush', { pw });
      if (r && (r.status === 'OK' || r.status === 'flushed')) {
        alert('Lista actualizada');
        try { localStorage.removeItem(LS_KEY); } catch {}
        respuesta.value = '';     // limpia el campo
        cargarGrupos();           // recarga roster
      } else {
        alert('Error: ' + (r && r.error ? r.error : 'No se pudo actualizar'));
      }
    } catch {
      alert('Error al actualizar');
    }
    return; // <- salimos, NO registramos asistencia
  }

  // 2) FICHAJE NORMAL (no hay @admin <clave> en la respuesta)
  e.preventDefault();
  if(lat.value === '' || lon.value === '') { alert('Necesitamos tu ubicación'); return; }

  btnEnviar.disabled = true;
  btnEnviar.classList.add('opacity-60','cursor-not-allowed');
  btnEnviar.textContent = 'Enviando…';

  const payload = {
    modalidad: modalidadSel.value,
    curso    : cursoSel.value,
    sistema  : sistemaSel.value,
    alumno   : alumnoSel.value,
    respuesta: respuesta.value,       // <- texto libre, NO se valida
    ua       : ua.value,
    ip       : ip.value,
    lat      : lat.value,
    lon      : lon.value,
    uuid     : uuid.value,
    finger   : finger.value
  };

  try {
    const r = await apiPOST('/registro', payload);
    if (r && r.status === 'OK') {
      const ahora = new Date();
      document.getElementById('resumen').textContent =
        `${alumnoSel.value} registrado el ${ahora.toLocaleDateString('es-ES')} ` +
        `a las ${ahora.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}.`;
      form.classList.add('hidden');
      document.getElementById('ok').classList.remove('hidden');
    } else {
      alert('Error: ' + (r && r.error ? r.error : 'desconocido'));
      btnEnviar.disabled=false;
      btnEnviar.classList.remove('opacity-60','cursor-not-allowed');
      btnEnviar.textContent='Enviar asistencia';
    }
  } catch {
    alert('Error de red');
    btnEnviar.disabled=false;
    btnEnviar.classList.remove('opacity-60','cursor-not-allowed');
    btnEnviar.textContent='Enviar asistencia';
  }
});
</script>

